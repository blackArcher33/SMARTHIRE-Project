<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Matching - HR Analytics</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@700;800&display=swap"
        rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="index.html" class="navbar-brand">HR Analytics</a>
            <ul class="navbar-nav">
                <li><a href="prediction.html" class="nav-link">Predict Applications</a></li>
                <li><a href="matching.html" class="nav-link"
                        style="background: rgba(99, 102, 241, 0.1); color: var(--text-primary);">Match Resumes</a></li>
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
            </ul>
        </div>
    </nav>

    <div class="container" style="padding: var(--spacing-xl) 0;">
        <div class="text-center mb-4">
            <h1 class="text-gradient">Resume Matching & Filtering</h1>
            <p style="font-size: 1.125rem; color: var(--text-secondary);">
                Upload resumes and job descriptions to get AI-powered matching scores
            </p>
        </div>

        <div class="grid grid-2">
            <!-- Upload Section -->
            <div class="card">
                <h3 class="card-title">Upload Documents</h3>
                <form id="matchingForm">
                    <div class="form-group">
                        <label class="form-label">Resume (PDF or DOCX)</label>
                        <div class="file-upload" id="resumeUpload">
                            <div class="file-upload-icon">üìÑ</div>
                            <p><strong>Click to upload</strong> or drag and drop</p>
                            <p style="font-size: 0.875rem; color: var(--text-muted);">PDF or DOCX (Max 5MB)</p>
                            <input type="file" id="resumeFile" accept=".pdf,.doc,.docx" style="display: none;" required>
                        </div>
                        <div id="resumeFileName"
                            style="margin-top: var(--spacing-xs); color: var(--accent); display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Job Description</label>
                        <div style="margin-bottom: var(--spacing-xs);">
                            <label style="display: inline-flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="jdType" value="text" checked
                                    style="margin-right: var(--spacing-xs);">
                                <span>Paste Text</span>
                            </label>
                            <label
                                style="display: inline-flex; align-items: center; cursor: pointer; margin-left: var(--spacing-md);">
                                <input type="radio" name="jdType" value="file" style="margin-right: var(--spacing-xs);">
                                <span>Upload File</span>
                            </label>
                        </div>

                        <div id="jdTextArea">
                            <textarea id="jobDescriptionText" class="form-textarea"
                                placeholder="Paste the job description here..." required></textarea>
                        </div>

                        <div id="jdFileArea" style="display: none;">
                            <div class="file-upload" id="jdUpload">
                                <div class="file-upload-icon">üìã</div>
                                <p><strong>Click to upload</strong> or drag and drop</p>
                                <p style="font-size: 0.875rem; color: var(--text-muted);">PDF or DOCX (Max 5MB)</p>
                                <input type="file" id="jdFile" accept=".pdf,.doc,.docx" style="display: none;">
                            </div>
                            <div id="jdFileName"
                                style="margin-top: var(--spacing-xs); color: var(--accent); display: none;"></div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-secondary" style="width: 100%;" id="matchBtn">
                        <span id="matchBtnText">Analyze Match</span>
                        <span id="matchBtnLoading" class="loading" style="display: none;"></span>
                    </button>
                </form>
            </div>

            <!-- Results Section -->
            <div class="card" id="resultsPanel" style="display: none;">
                <h3 class="card-title">Match Analysis</h3>

                <div class="text-center" style="padding: var(--spacing-lg) 0;">
                    <div class="progress-circle" id="progressCircle" style="margin: 0 auto; --progress: 0%;">
                        <div class="progress-value" id="scoreValue">0%</div>
                    </div>
                    <p style="font-size: 1.25rem; color: var(--text-secondary); margin-top: var(--spacing-md);">
                        Match Score
                    </p>
                    <div id="matchCategoryBadge" style="margin-top: var(--spacing-sm);"></div>
                </div>

                <div
                    style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-top: var(--spacing-md);">
                    <h5 style="margin-bottom: var(--spacing-sm);">Priority Level</h5>
                    <div id="priorityBadge"></div>
                </div>

                <div style="margin-top: var(--spacing-md);">
                    <h5 style="margin-bottom: var(--spacing-sm);">‚úÖ Matched Skills</h5>
                    <div id="matchedSkills" style="display: flex; flex-wrap: wrap; gap: var(--spacing-xs);"></div>
                </div>

                <div style="margin-top: var(--spacing-md);">
                    <h5 style="margin-bottom: var(--spacing-sm);">‚ùå Missing Skills</h5>
                    <div id="missingSkills" style="display: flex; flex-wrap: wrap; gap: var(--spacing-xs);"></div>
                </div>

                <div
                    style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: rgba(99, 102, 241, 0.1); border-radius: var(--radius-md); border-left: 4px solid var(--primary);">
                    <h5 style="margin-bottom: var(--spacing-sm);">üí° Recommendation</h5>
                    <p id="recommendation" style="margin: 0; color: var(--text-secondary);"></p>
                </div>

                <button class="btn btn-outline" style="width: 100%; margin-top: var(--spacing-md);"
                    onclick="resetMatchForm()">
                    Analyze Another Resume
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let resumeFileData = null;
        let jdFileData = null;

        // File upload handlers
        document.getElementById('resumeUpload').addEventListener('click', () => {
            document.getElementById('resumeFile').click();
        });

        document.getElementById('resumeFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                resumeFileData = file;
                document.getElementById('resumeFileName').textContent = `‚úì ${file.name}`;
                document.getElementById('resumeFileName').style.display = 'block';
            }
        });

        document.getElementById('jdUpload').addEventListener('click', () => {
            document.getElementById('jdFile').click();
        });

        document.getElementById('jdFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                jdFileData = file;
                document.getElementById('jdFileName').textContent = `‚úì ${file.name}`;
                document.getElementById('jdFileName').style.display = 'block';
            }
        });

        // JD type toggle
        document.querySelectorAll('input[name="jdType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'text') {
                    document.getElementById('jdTextArea').style.display = 'block';
                    document.getElementById('jdFileArea').style.display = 'none';
                    document.getElementById('jobDescriptionText').required = true;
                } else {
                    document.getElementById('jdTextArea').style.display = 'none';
                    document.getElementById('jdFileArea').style.display = 'block';
                    document.getElementById('jobDescriptionText').required = false;
                }
            });
        });

        // Form submission
        document.getElementById('matchingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!resumeFileData) {
                alert('Please upload a resume file.');
                return;
            }

            const jdType = document.querySelector('input[name="jdType"]:checked').value;
            const jdText = document.getElementById('jobDescriptionText').value;

            if (jdType === 'text' && !jdText) {
                alert('Please enter a job description.');
                return;
            }

            if (jdType === 'file' && !jdFileData) {
                alert('Please upload a job description file.');
                return;
            }

            // Prepare form data
            const formData = new FormData();
            formData.append('resume', resumeFileData);

            if (jdType === 'text') {
                formData.append('jobDescriptionText', jdText);
            } else {
                formData.append('jobDescription', jdFileData);
            }

            // Show loading state
            const btn = document.getElementById('matchBtn');
            const btnText = document.getElementById('matchBtnText');
            const btnLoading = document.getElementById('matchBtnLoading');
            btn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';

            try {
                const response = await fetch(`${API_URL}/match-resume`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    displayMatchResults(data.result);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Failed to connect to server. Make sure the backend is running.');
                console.error(error);
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
            }
        });

        function displayMatchResults(result) {
            // Show results panel
            document.getElementById('resultsPanel').style.display = 'block';
            document.getElementById('resultsPanel').classList.add('fade-in');

            // Animate score
            const score = result.score;
            const progressCircle = document.getElementById('progressCircle');
            const scoreValue = document.getElementById('scoreValue');

            let currentScore = 0;
            const interval = setInterval(() => {
                currentScore += 1;
                if (currentScore >= score) {
                    currentScore = score;
                    clearInterval(interval);
                }
                progressCircle.style.setProperty('--progress', `${currentScore}%`);
                scoreValue.textContent = `${currentScore}%`;
            }, 20);

            // Display category badge
            const categoryColors = {
                'Excellent': 'success',
                'Good': 'info',
                'Average': 'warning',
                'Poor': 'danger'
            };
            const categoryBadge = document.getElementById('matchCategoryBadge');
            categoryBadge.innerHTML = `<span class="badge badge-${categoryColors[result.category]}" style="font-size: 1rem; padding: 0.5rem 1.5rem;">${result.category} Match</span>`;

            // Display priority badge
            const priorityColors = {
                'High': 'success',
                'Medium': 'warning',
                'Low': 'info',
                'Very Low': 'danger'
            };
            const priorityBadge = document.getElementById('priorityBadge');
            priorityBadge.innerHTML = `<span class="badge badge-${priorityColors[result.priority]}" style="font-size: 1rem; padding: 0.5rem 1.5rem;">${result.priority} Priority</span>`;

            // Display matched skills
            const matchedSkills = document.getElementById('matchedSkills');
            if (result.matched_skills && result.matched_skills.length > 0) {
                matchedSkills.innerHTML = result.matched_skills.map(skill =>
                    `<span class="pill pill-matched">${skill}</span>`
                ).join('');
            } else {
                matchedSkills.innerHTML = '<p style="color: var(--text-muted);">No specific skills matched</p>';
            }

            // Display missing skills
            const missingSkills = document.getElementById('missingSkills');
            if (result.missing_skills && result.missing_skills.length > 0) {
                missingSkills.innerHTML = result.missing_skills.map(skill =>
                    `<span class="pill pill-missing">${skill}</span>`
                ).join('');
            } else {
                missingSkills.innerHTML = '<p style="color: var(--text-muted);">No critical skills missing</p>';
            }

            // Display recommendation
            document.getElementById('recommendation').textContent = result.recommendation;

            // Scroll to results
            document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function resetMatchForm() {
            document.getElementById('matchingForm').reset();
            document.getElementById('resultsPanel').style.display = 'none';
            document.getElementById('resumeFileName').style.display = 'none';
            document.getElementById('jdFileName').style.display = 'none';
            resumeFileData = null;
            jdFileData = null;
        }
    </script>
</body>

</html>